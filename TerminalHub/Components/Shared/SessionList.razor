@using TerminalHub.Models
@using TerminalHub.Constants

<style>
    .active-session {
        border: 2px solid #0d6efd !important;
        background-color: #e7f1ff !important;
    }
    
    .active-session:hover {
        background-color: #d7e9ff !important;
    }
    
    @@keyframes bell-ring {
        0% { transform: rotate(0); }
        10% { transform: rotate(14deg); }
        20% { transform: rotate(-8deg); }
        30% { transform: rotate(14deg); }
        40% { transform: rotate(-4deg); }
        50% { transform: rotate(10deg); }
        60% { transform: rotate(0); }
        100% { transform: rotate(0); }
    }
    
    .bi-bell-fill {
        animation: bell-ring 2s ease-in-out infinite;
    }
</style>

<div class="col-md-3 border-end bg-light p-3 d-flex flex-column" style="height: 100vh;">

    <div class="mb-2">
        <button class="btn btn-primary w-100" @onclick="() => OnAddSession.InvokeAsync()" disabled="@IsAddingSession">
            <i class="bi bi-plus-circle"></i> 新しいセッションを作成
        </button>
    </div>

    <div class="mb-2">
        <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="セッションを検索..."
                   @bind="filterText" @bind:event="oninput" />
            @if (!string.IsNullOrEmpty(filterText))
            {
                <button class="btn btn-outline-secondary" type="button" @onclick="() => filterText = string.Empty">
                    <i class="bi bi-x"></i>
                </button>
            }
            <button class="btn btn-outline-secondary" type="button" @onclick="() => OnShowArchivedSessions.InvokeAsync()"
                    title="アーカイブ済みセッション">
                <i class="bi bi-archive"></i>
                @{
                    var archivedCount = Sessions.Count(s => s.IsArchived);
                }
                @if (archivedCount > 0)
                {
                    <span class="badge bg-secondary ms-1">@archivedCount</span>
                }
            </button>
        </div>
    </div>

    <div class="list-group flex-grow-1" style="overflow-y: auto;">
        @{
            var groupedSessions = GetGroupedSessions();
        }
        @foreach (var sessionGroup in groupedSessions)
        {
            @foreach (var session in sessionGroup)
            {
                <div class="list-group-item list-group-item-action @(session.SessionId == ActiveSessionId ? "active-session" : "")" 
                     @onclick="async () => await HandleSessionClick(session.SessionId)"
                     style="cursor: pointer; @(session.ParentSessionId.HasValue ? "padding-left: 2.5rem;" : "")">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="flex-fill">
                            <h6 class="mb-1">
                                @if (!session.ParentSessionId.HasValue && HasChildren(session))
                                {
                                    <button class="btn btn-sm btn-link text-decoration-none p-0 me-1"
                                            @onclick:stopPropagation="true"
                                            @onclick="async () => await ToggleExpanded(session.SessionId)"
                                            style="font-size: 0.8rem; line-height: 1;">
                                        <i class="bi @(session.IsExpanded ? "bi-chevron-down" : "bi-chevron-right")"></i>
                                    </button>
                                }
                            @if (session.HasNotificationPending)
                            {
                                <span class="text-danger me-1" title="処理が完了しました">
                                    <i class="bi bi-bell-fill"></i>
                                </span>
                            }
                            @session.GetDisplayName()
                            @if (session.TerminalType != TerminalType.Terminal)
                            {
                                <span class="badge bg-info ms-2">@GetTerminalTypeBadge(session.TerminalType)</span>
                            }
                            @if (session.IsGitRepository && !string.IsNullOrEmpty(session.GitBranch))
                            {
                                <span class="badge @(session.IsWorktree ? "bg-warning" : "bg-success") ms-1" title="@(session.IsWorktree ? "Worktree" : "Git ブランチ")">
                                    <i class="bi @(session.IsWorktree ? "bi-git" : "bi-git") me-1"></i>@session.GitBranch
                                    @if (session.HasUncommittedChanges)
                                    {
                                        <i class="bi bi-circle-fill text-danger git-status-indicator" title="未コミットの変更があります"></i>
                                    }
                                </span>
                            }
                            @if (!session.ParentSessionId.HasValue && HasChildren(session) && !session.IsExpanded)
                            {
                                <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">
                                    @GetChildrenCount(session) 件
                                </span>
                            }
                            @if (!session.IsWorktree)
                            {
                                <button class="btn btn-sm btn-outline-success border-0 ms-1" 
                                        @onclick:stopPropagation="true"
                                        @onclick="() => OnCreateWorktree.InvokeAsync(session.SessionId)"
                                        title="@(session.IsGitRepository ? "新しいWorktreeを作成" : "サブセッションを作成")"
                                        style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            }
                        </h6>
                        @if (session.ProcessingElapsedSeconds.HasValue || !string.IsNullOrEmpty(session.ProcessingStatus))
                        {
                            <div>
                                <small class="@(session.IsWaitingForUserInput ? "text-warning" : "text-primary")">
                                    @if (session.IsWaitingForUserInput)
                                    {
                                        <i class="bi bi-person-fill-exclamation me-1"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-clock-fill me-1"></i>
                                    }
                                    @if (!string.IsNullOrEmpty(session.ProcessingStatus))
                                    {
                                        <span>@session.ProcessingStatus</span>
                                    }
                                </small>
                            </div>
                        }
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm border-0 opacity-50" @onclick:stopPropagation="true" 
                                @onclick="() => OnSessionSettings.InvokeAsync(session.SessionId)"
                                title="セッション設定"
                                style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                            <i class="bi bi-gear"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm border-0 opacity-50" @onclick:stopPropagation="true" 
                                @onclick="() => OnSessionRemove.InvokeAsync(session.SessionId)"
                                title="セッション削除"
                                style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                @* メモ表示: メモがある場合のみ表示（編集はセッション設定から） *@
                @if (!string.IsNullOrWhiteSpace(session.Memo))
                {
                    <div class="mt-2">
                        <div class="text-muted small" 
                             style="font-size: 0.875rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; background-color: rgba(0,0,0,0.03);">
                            @session.Memo
                        </div>
                    </div>
                }
            </div>
            }
        }
    </div>

    @if (!Sessions.Any())
    {
        <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle"></i> ボタンをクリックしてセッションを作成してください
        </div>
    }

    <!-- 設定ボタンとショートカット説明を最下部に固定 -->
    <div class="mt-auto border-top" style="position: sticky; bottom: 0; background-color: #f8f9fa;">
        <div class="p-2">
            <button class="btn btn-outline-secondary btn-sm w-100" @onclick="OnSettingsClick">
                <i class="bi bi-gear me-1"></i>設定
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public List<SessionInfo> Sessions { get; set; } = new();
    [Parameter] public Guid? ActiveSessionId { get; set; }
    [Parameter] public bool IsAddingSession { get; set; }

    private string filterText = string.Empty;

    [Parameter] public EventCallback OnAddSession { get; set; }
    [Parameter] public EventCallback<Guid> OnSessionSelect { get; set; }
    [Parameter] public Func<Guid, Task> OnGitStatusRefresh { get; set; } = _ => Task.CompletedTask;
    [Parameter] public EventCallback<Guid> OnSessionRemove { get; set; }
    [Parameter] public EventCallback OnSettingsClick { get; set; }
    [Parameter] public EventCallback<Guid> OnCreateWorktree { get; set; }
    [Parameter] public EventCallback<Guid> OnSessionSettings { get; set; }
    [Parameter] public EventCallback<(Guid sessionId, bool isExpanded)> OnSessionExpandedChanged { get; set; }
    [Parameter] public EventCallback OnShowArchivedSessions { get; set; }

    protected override void OnParametersSet()
    {
        StateHasChanged();
    }

    private string GetTerminalTypeBadge(TerminalType terminalType)
    {
        return terminalType switch
        {
            TerminalType.ClaudeCode => "Claude",
            TerminalType.GeminiCLI => "Gemini",
            TerminalType.CodexCLI => "Codex",
            _ => "Terminal"
        };
    }
    
    private List<List<SessionInfo>> GetGroupedSessions()
    {
        var result = new List<List<SessionInfo>>();
        var processed = new HashSet<Guid>();

        // フィルターに一致するセッションを取得
        var filteredSessions = GetFilteredSessions();

        // まず親セッションとその子セッションをグループ化
        foreach (var session in filteredSessions.OrderBy(s => s.CreatedAt))
        {
            if (processed.Contains(session.SessionId))
                continue;
                
            var group = new List<SessionInfo>();
            
            // ParentSessionIdを持たない場合は親セッション
            if (!session.ParentSessionId.HasValue)
            {
                group.Add(session);
                processed.Add(session.SessionId);

                // 親セッションが展開されている場合のみ子セッションを表示
                if (session.IsExpanded)
                {
                    // 子セッション（ParentSessionIdがこのセッションを指すもの）を探す
                    var children = filteredSessions
                        .Where(s => s.ParentSessionId == session.SessionId)
                        .OrderBy(s => s.CreatedAt);

                    foreach (var child in children)
                    {
                        group.Add(child);
                        processed.Add(child.SessionId);
                    }
                }
                else
                {
                    // 折りたたまれている場合も子セッションを処理済みとしてマーク
                    var children = Sessions
                        .Where(s => s.ParentSessionId == session.SessionId);

                    foreach (var child in children)
                    {
                        processed.Add(child.SessionId);
                    }
                }
            }
            // 親が存在しない子セッションの場合（親が削除された場合など）
            else if (!Sessions.Any(s => s.SessionId == session.ParentSessionId))
            {
                group.Add(session);
                processed.Add(session.SessionId);
            }
            
            if (group.Any())
            {
                result.Add(group);
            }
        }
        
        return result;
    }
    
    private async Task HandleSessionClick(Guid sessionId)
    {
        // セッションを選択
        await OnSessionSelect.InvokeAsync(sessionId);
        
        // Gitステータスを再確認
        await OnGitStatusRefresh(sessionId);
    }
    
    private bool HasChildren(SessionInfo session)
    {
        return Sessions.Any(s => s.ParentSessionId == session.SessionId);
    }
    
    private async Task ToggleExpanded(Guid sessionId)
    {
        var session = Sessions.FirstOrDefault(s => s.SessionId == sessionId);
        if (session != null)
        {
            session.IsExpanded = !session.IsExpanded;
            StateHasChanged();
            
            // 展開状態の変更を親コンポーネントに通知
            await OnSessionExpandedChanged.InvokeAsync((sessionId, session.IsExpanded));
        }
    }
    
    private int GetChildrenCount(SessionInfo session)
    {
        return Sessions.Count(s => s.ParentSessionId == session.SessionId);
    }

    private List<SessionInfo> GetFilteredSessions()
    {
        // アーカイブされていないセッションのみを対象にする
        var activeSessions = Sessions.Where(s => !s.IsArchived).ToList();

        if (string.IsNullOrWhiteSpace(filterText))
        {
            return activeSessions;
        }

        // 親セッションのみをフィルター対象にする
        // 子セッションは親がフィルターに一致すれば表示される
        var filter = filterText.Trim().ToLowerInvariant();
        var matchingParentIds = new HashSet<Guid>();

        // まず親セッションでフィルターに一致するものを探す
        foreach (var session in activeSessions.Where(s => !s.ParentSessionId.HasValue))
        {
            if (MatchesFilter(session, filter))
            {
                matchingParentIds.Add(session.SessionId);
            }
        }

        // 一致した親セッションとその子セッションを返す
        return activeSessions.Where(s =>
            matchingParentIds.Contains(s.SessionId) ||
            (s.ParentSessionId.HasValue && matchingParentIds.Contains(s.ParentSessionId.Value))
        ).ToList();
    }

    private bool MatchesFilter(SessionInfo session, string filter)
    {
        // セッション名で検索
        if (session.GetDisplayName().ToLowerInvariant().Contains(filter))
        {
            return true;
        }

        // メモ（説明）で検索
        if (!string.IsNullOrEmpty(session.Memo) && session.Memo.ToLowerInvariant().Contains(filter))
        {
            return true;
        }

        return false;
    }
}