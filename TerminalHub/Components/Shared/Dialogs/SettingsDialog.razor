@namespace TerminalHub.Components.Shared.Dialogs
@using TerminalHub.Services
@using TerminalHub.Models
@using Microsoft.Extensions.Configuration
@inject INotificationService NotificationService
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorageService
@inject IWebhookSettingsService WebhookSettingsService
@inject ISessionManager SessionManager

@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear-fill me-2"></i>設定
                    </h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- タブナビゲーション -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "general" ? "active" : "")" 
                                    type="button" 
                                    @onclick="@(() => activeTab = "general")">
                                <i class="bi bi-gear me-1"></i>一般
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "notifications" ? "active" : "")" 
                                    type="button" 
                                    @onclick="@(() => activeTab = "notifications")">
                                <i class="bi bi-bell me-1"></i>通知
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "sessions" ? "active" : "")" 
                                    type="button" 
                                    @onclick="@(() => activeTab = "sessions")">
                                <i class="bi bi-terminal me-1"></i>セッション
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "export" ? "active" : "")"
                                    type="button"
                                    @onclick="@(() => activeTab = "export")">
                                <i class="bi bi-download me-1"></i>エクスポート/インポート
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "special" ? "active" : "")"
                                    type="button"
                                    @onclick="@(() => activeTab = "special")">
                                <i class="bi bi-wrench me-1"></i>特殊
                            </button>
                        </li>
                        @if (devToolsEnabled)
                        {
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "devDiagnose" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "devDiagnose")">
                                    <i class="bi bi-bug me-1"></i>診断
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "devBuffer" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "devBuffer")">
                                    <i class="bi bi-hdd me-1"></i>バッファ
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "devNotify" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "devNotify")">
                                    <i class="bi bi-bell-fill me-1"></i>通知テスト
                                </button>
                            </li>
                        }
                    </ul>
                    
                    <!-- タブコンテンツ -->
                    <div class="tab-content">
                        @if (activeTab == "general")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">一般設定</h6>
                                <p class="text-muted">今後追加予定</p>
                            </div>
                        }
                        else if (activeTab == "notifications")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">通知設定</h6>
                    
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <label class="form-label mb-0">ブラウザ通知</label>
                            <span class="badge @GetNotificationBadgeClass()">@notificationStatus</span>
                        </div>
                        @if (notificationStatus == "許可済み")
                        {
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" @bind="browserNotificationEnabled" id="browserNotificationSwitch">
                                <label class="form-check-label" for="browserNotificationSwitch">
                                    ブラウザ通知を有効にする
                                </label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="OpenBrowserNotificationSettings">
                                <i class="bi bi-gear me-1"></i>通知許可を解除
                            </button>
                            <p class="text-muted small mt-2 mb-0">
                                ブラウザの設定画面で通知許可を解除できます。
                            </p>
                        }
                        else if (notificationStatus == "未許可")
                        {
                            <button class="btn btn-primary btn-sm" @onclick="RequestNotificationPermission">
                                <i class="bi bi-bell me-1"></i>通知を許可する
                            </button>
                            <p class="text-muted small mt-2 mb-0">
                                処理完了時にデスクトップ通知を受け取るには、ブラウザの通知を許可してください。
                            </p>
                        }
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">通知を送信する処理時間（秒）</label>
                        <input type="number" class="form-control" @bind="thresholdSeconds" min="0" max="3600" />
                        <small class="text-muted">0に設定すると、すべての処理完了時に通知します</small>
                    </div>
                    
                    <hr />
                    
                    <h6 class="mb-3">WebHook設定</h6>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="webHookEnabled" id="webHookSwitch">
                            <label class="form-check-label" for="webHookSwitch">
                                WebHook通知を有効にする
                            </label>
                        </div>
                    </div>
                    
                    @if (webHookEnabled)
                    {
                        <div class="mb-3">
                            <label class="form-label">WebHook URL</label>
                            <input type="url" class="form-control" @bind="webHookUrl" placeholder="https://example.com/webhook" />
                        </div>
                    }

                    <hr />

                    <h6 class="mb-3">Claude Code Hook設定</h6>
                    <p class="text-muted small mb-3">
                        Claude Code の hook 機能を使用して、より確実に通知を受け取ることができます。
                        セッション作成時に自動的に <code>.claude/settings.local.json</code> に設定が追加されます。
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="claudeHookEnabled" id="claudeHookSwitch">
                            <label class="form-check-label" for="claudeHookSwitch">
                                Claude Code Hook を有効にする
                            </label>
                        </div>
                    </div>

                    @if (claudeHookEnabled)
                    {
                        <div class="mb-3">
                            <label class="form-label">通知するイベント</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="hookEventStop" id="hookEventStop">
                                <label class="form-check-label" for="hookEventStop">
                                    Stop（処理完了時）
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="hookEventUserPromptSubmit" id="hookEventUserPromptSubmit">
                                <label class="form-check-label" for="hookEventUserPromptSubmit">
                                    UserPromptSubmit（ユーザー入力時）
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="hookEventNotification" id="hookEventNotification">
                                <label class="form-check-label" for="hookEventNotification">
                                    Notification（通知発生時）
                                </label>
                            </div>
                        </div>
                    }
                            </div>
                        }
                        else if (activeTab == "sessions")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">セッション設定</h6>

                                <div class="mb-4">
                                    <label class="form-label">セッション一覧の並び順</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sessionSortMode"
                                               id="sortByCreatedAt" value="createdAt" checked="@(sessionSortMode == "createdAt")"
                                               @onchange="@(() => sessionSortMode = "createdAt")">
                                        <label class="form-check-label" for="sortByCreatedAt">
                                            <i class="bi bi-calendar-plus me-1"></i>作成日時順
                                            <span class="text-muted small">（デフォルト）</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sessionSortMode"
                                               id="sortByLastAccessed" value="lastAccessed" checked="@(sessionSortMode == "lastAccessed")"
                                               @onchange="@(() => sessionSortMode = "lastAccessed")">
                                        <label class="form-check-label" for="sortByLastAccessed">
                                            <i class="bi bi-clock-history me-1"></i>最終利用日時順
                                            <span class="text-muted small">（最近使用したセッションが上に表示）</span>
                                        </label>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        「最終利用日時順」では、子セッション（Worktree）の利用も親セッションの順序に反映されます。
                                    </p>
                                </div>
                            </div>
                        }
                        else if (activeTab == "export")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">データのエクスポート/インポート</h6>

                                <!-- エクスポート -->
                                <div class="mb-4">
                                    <h6 class="mb-2">エクスポート</h6>
                                    <p class="text-muted small">選択したカテゴリのデータをJSONファイルとしてダウンロードします。</p>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="exportCategories.notifications" id="exportNotifications">
                                            <label class="form-check-label" for="exportNotifications">
                                                <i class="bi bi-bell me-1"></i>通知設定
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="exportCategories.sessions" id="exportSessions">
                                            <label class="form-check-label" for="exportSessions">
                                                <i class="bi bi-terminal me-1"></i>セッション情報
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="exportCategories.ui" id="exportUI">
                                            <label class="form-check-label" for="exportUI">
                                                <i class="bi bi-window me-1"></i>UI設定
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="exportCategories.history" id="exportHistory">
                                            <label class="form-check-label" for="exportHistory">
                                                <i class="bi bi-clock-history me-1"></i>履歴
                                            </label>
                                        </div>
                                    </div>

                                    <button class="btn btn-primary btn-sm" @onclick="ExportSettings" disabled="@(!HasExportSelection)">
                                        <i class="bi bi-download me-1"></i>エクスポート
                                    </button>
                                </div>

                                <hr />

                                <!-- インポート -->
                                <div>
                                    <h6 class="mb-2">インポート</h6>
                                    <p class="text-muted small">JSONファイルを選択して設定をインポートします。</p>

                                    <div class="mb-3">
                                        <InputFile OnChange="@LoadImportFile" accept=".json" class="form-control" />
                                    </div>

                                    @if (importPreview != null)
                                    {
                                        <div class="alert alert-info">
                                            <h6 class="alert-heading">インポートプレビュー</h6>
                                            <small>
                                                @foreach (var category in importPreview)
                                                {
                                                    <div>
                                                        <i class="bi bi-check-circle me-1"></i>@GetCategoryDisplayName(category)
                                                    </div>
                                                }
                                            </small>
                                        </div>

                                        <button class="btn btn-warning btn-sm" @onclick="ImportSettings">
                                            <i class="bi bi-upload me-1"></i>インポート実行
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        else if (activeTab == "special")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">特殊設定</h6>

                                <div class="mb-4">
                                    <h6 class="mb-2">Claude Code モード切替キー</h6>
                                    <p class="text-muted small">Claude Codeでモード切替に使用するキーボードショートカットを選択します。</p>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="claudeModeSwitchKey"
                                                   id="keyAltM" value="altM" checked="@(claudeModeSwitchKey == "altM")"
                                                   @onchange="@(() => claudeModeSwitchKey = "altM")">
                                            <label class="form-check-label" for="keyAltM">
                                                <kbd>Alt+M</kbd> <span class="text-muted">（デフォルト）</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="claudeModeSwitchKey"
                                                   id="keyShiftTab" value="shiftTab" checked="@(claudeModeSwitchKey == "shiftTab")"
                                                   @onchange="@(() => claudeModeSwitchKey = "shiftTab")">
                                            <label class="form-check-label" for="keyShiftTab">
                                                <kbd>Shift+Tab</kbd>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        環境によってはAlt+Mが他の機能と競合する場合があります。その場合はShift+Tabをお試しください。
                                    </p>
                                </div>

                                <hr />

                                <div class="mb-4">
                                    <h6 class="mb-2">開発ツール</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" @bind="devToolsEnabled" id="devToolsSwitch">
                                        <label class="form-check-label" for="devToolsSwitch">
                                            開発ツールを有効にする
                                        </label>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        有効にすると、診断・バッファ・通知テストのタブが表示されます。
                                    </p>
                                </div>
                            </div>
                        }
                        else if (activeTab == "devDiagnose")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">診断情報</h6>

                                <div class="mb-3">
                                    <button class="btn btn-info btn-sm me-2" @onclick="RefreshDiagnostics">
                                        <i class="bi bi-arrow-clockwise me-1"></i>診断情報を更新
                                    </button>
                                    <button class="btn btn-warning btn-sm" @onclick="RunJSDiagnostics">
                                        <i class="bi bi-bug me-1"></i>JS診断実行
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <h6>セッション一覧</h6>
                                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>名前</th>
                                                    <th>状態</th>
                                                    <th>ConPTY</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var session in diagnosticSessions)
                                                {
                                                    <tr>
                                                        <td class="text-truncate" style="max-width: 150px;">@session.GetDisplayName()</td>
                                                        <td>
                                                            <span class="badge @(session.IsActive ? "bg-success" : "bg-secondary")">
                                                                @(session.IsActive ? "Active" : "Inactive")
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="badge @(session.ConPtySession != null ? "bg-primary" : "bg-warning")">
                                                                @(session.ConPtySession != null ? "有" : "無")
                                                            </span>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>ターミナル情報</h6>
                                    <p class="mb-1">JavaScript側ターミナル数: <span class="badge bg-info">@jsTerminalCount</span></p>
                                </div>

                                <hr />

                                <h6 class="mb-3">ターミナル制御テスト</h6>
                                <div class="mb-3">
                                    <button class="btn btn-primary btn-sm me-2" @onclick="ScrollToBottom">
                                        <i class="bi bi-arrow-down me-1"></i>最下部へ
                                    </button>
                                    <button class="btn btn-secondary btn-sm me-2" @onclick="ScrollToTop">
                                        <i class="bi bi-arrow-up me-1"></i>最上部へ
                                    </button>
                                    <button class="btn btn-info btn-sm" @onclick="GetScrollPosition">
                                        <i class="bi bi-info-circle me-1"></i>位置取得
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">@scrollInfo</small>
                                </div>
                            </div>
                        }
                        else if (activeTab == "devBuffer")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">バッファキャプチャ</h6>

                                <div class="mb-3">
                                    <label class="form-label">セッション選択</label>
                                    <select class="form-select" @bind="selectedSessionForBuffer">
                                        <option value="">-- セッションを選択 --</option>
                                        @foreach (var session in GetAvailableSessions())
                                        {
                                            var captureStatus = session.EnableBufferCapture ? " [キャプチャ中]" : "";
                                            var bufferSize = session.CapturedBufferSize > 0 ? $" ({FormatBytes(session.CapturedBufferSize)})" : "";
                                            <option value="@session.SessionId">@session.GetDisplayName()@captureStatus@bufferSize</option>
                                        }
                                    </select>
                                </div>

                                @if (GetSelectedBufferSession() is SessionInfo selectedSession)
                                {
                                    <div class="mb-3">
                                        <span class="badge @(selectedSession.EnableBufferCapture ? "bg-success" : "bg-secondary") me-2">
                                            @(selectedSession.EnableBufferCapture ? "キャプチャ中" : "停止中")
                                        </span>
                                        @if (selectedSession.CapturedBufferSize > 0)
                                        {
                                            <span class="badge bg-info">@FormatBytes(selectedSession.CapturedBufferSize)</span>
                                        }
                                    </div>
                                }

                                <div class="mb-3">
                                    <div class="btn-group me-2">
                                        <button class="btn btn-success btn-sm" @onclick="StartCapture"
                                                disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.EnableBufferCapture == true)">
                                            <i class="bi bi-record-circle me-1"></i>開始
                                        </button>
                                        <button class="btn btn-warning btn-sm" @onclick="StopCapture"
                                                disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.EnableBufferCapture != true)">
                                            <i class="bi bi-stop-circle me-1"></i>停止
                                        </button>
                                        <button class="btn btn-danger btn-sm" @onclick="ClearBuffer"
                                                disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.CapturedBufferSize == 0)">
                                            <i class="bi bi-trash me-1"></i>クリア
                                        </button>
                                    </div>
                                    <button class="btn btn-primary btn-sm" @onclick="DownloadBuffer"
                                            disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.CapturedBufferSize == 0)">
                                        <i class="bi bi-download me-1"></i>ダウンロード
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">@bufferResult</small>
                                </div>
                            </div>
                        }
                        else if (activeTab == "devNotify")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">通知テスト</h6>

                                <div class="mb-3">
                                    <label class="form-label">テスト用経過時間（秒）</label>
                                    <input type="number" class="form-control" @bind="testElapsedSeconds" min="1" max="300" style="max-width: 150px;" />
                                </div>

                                <div class="mb-3">
                                    <button class="btn btn-warning btn-sm me-2" @onclick="TestBrowserNotification">
                                        <i class="bi bi-bell me-1"></i>ブラウザ通知テスト
                                    </button>
                                    <button class="btn btn-success btn-sm" @onclick="TestWebHookNotification">
                                        <i class="bi bi-send me-1"></i>WebHook通知テスト
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">@notificationTestResult</small>
                                </div>
                            </div>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(saveMessage))
                    {
                        <div class="alert @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
                            @saveMessage
                            <button type="button" class="btn-close" @onclick="() => saveMessage = string.Empty"></button>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">キャンセル</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSettings">
                        <i class="bi bi-save me-1"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    private string notificationStatus = "確認中...";
    private int thresholdSeconds = 60;
    private bool browserNotificationEnabled = true;
    private bool webHookEnabled = false;
    private string webHookUrl = "";
    private bool claudeHookEnabled = true;
    private bool hookEventStop = true;
    private bool hookEventUserPromptSubmit = true;
    private bool hookEventNotification = true;
    private string saveMessage = "";
    private bool saveSuccess = false;
    private string activeTab = "notifications";
    private string claudeModeSwitchKey = "altM";
    private string sessionSortMode = "createdAt";

    // 開発ツール関連
    private bool devToolsEnabled = false;
    private List<SessionInfo> diagnosticSessions = new();
    private int jsTerminalCount = 0;
    private string scrollInfo = "スクロール位置情報が表示されます";
    private string selectedSessionForBuffer = "";
    private string bufferResult = "";
    private int testElapsedSeconds = 10;
    private string notificationTestResult = "テスト結果がここに表示されます";

    [Parameter] public EventCallback<string> OnSessionSortModeChanged { get; set; }
    
    // エクスポート/インポート用
    private class ExportCategories
    {
        public bool notifications { get; set; } = false;
        public bool sessions { get; set; } = false;
        public bool ui { get; set; } = false;
        public bool history { get; set; } = false;
    }
    
    private ExportCategories exportCategories = new();
    private List<string>? importPreview = null;
    private Dictionary<string, object>? importData = null;
    
    private bool HasExportSelection => exportCategories.notifications || exportCategories.sessions || 
                                       exportCategories.ui || exportCategories.history;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadSettings();
            await CheckNotificationPermission();
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            // LocalStorageから設定を読み込み
            var settings = await JSRuntime.InvokeAsync<System.Text.Json.JsonElement?>("terminalHubHelpers.getSettings");
            if (settings.HasValue)
            {
                var s = settings.Value;
                if (s.TryGetProperty("notifications", out var notifications))
                {
                    if (notifications.TryGetProperty("enableBrowserNotifications", out var enabled))
                    {
                        browserNotificationEnabled = enabled.GetBoolean();
                    }
                    if (notifications.TryGetProperty("processingTimeThresholdSeconds", out var threshold))
                    {
                        thresholdSeconds = threshold.GetInt32();
                    }
                }
                if (s.TryGetProperty("webhook", out var webhook))
                {
                    if (webhook.TryGetProperty("enabled", out var enabled))
                    {
                        webHookEnabled = enabled.GetBoolean();
                    }
                    if (webhook.TryGetProperty("url", out var url))
                    {
                        webHookUrl = url.GetString() ?? "";
                    }
                }
                if (s.TryGetProperty("claudeHook", out var claudeHook))
                {
                    if (claudeHook.TryGetProperty("enabled", out var hookEnabled))
                    {
                        claudeHookEnabled = hookEnabled.GetBoolean();
                    }
                    if (claudeHook.TryGetProperty("events", out var events))
                    {
                        if (events.TryGetProperty("stop", out var stop))
                        {
                            hookEventStop = stop.GetBoolean();
                        }
                        if (events.TryGetProperty("userPromptSubmit", out var userPrompt))
                        {
                            hookEventUserPromptSubmit = userPrompt.GetBoolean();
                        }
                        if (events.TryGetProperty("notification", out var notif))
                        {
                            hookEventNotification = notif.GetBoolean();
                        }
                    }
                }
                if (s.TryGetProperty("special", out var special))
                {
                    if (special.TryGetProperty("claudeModeSwitchKey", out var key))
                    {
                        claudeModeSwitchKey = key.GetString() ?? "altM";
                    }
                }
                if (s.TryGetProperty("sessions", out var sessionsSettings))
                {
                    if (sessionsSettings.TryGetProperty("sortMode", out var sortMode))
                    {
                        sessionSortMode = sortMode.GetString() ?? "createdAt";
                    }
                }
                if (s.TryGetProperty("devTools", out var devTools))
                {
                    if (devTools.TryGetProperty("enabled", out var enabled))
                    {
                        devToolsEnabled = enabled.GetBoolean();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"設定読み込みエラー: {ex.Message}");
            // デフォルト値を使用
            thresholdSeconds = 5;
            webHookEnabled = false;
            webHookUrl = "";
            claudeModeSwitchKey = "altM";
            sessionSortMode = "createdAt";
            devToolsEnabled = false;
        }
    }
    
    private async Task CheckNotificationPermission()
    {
        try
        {
            var permission = await JSRuntime.InvokeAsync<string>("terminalHubHelpers.checkNotificationPermission");
            notificationStatus = permission switch
            {
                "granted" => "許可済み",
                "denied" => "拒否",
                "default" => "未許可",
                _ => "不明"
            };
        }
        catch
        {
            notificationStatus = "確認エラー";
        }
    }
    
    private async Task RequestNotificationPermission()
    {
        try
        {
            var granted = await NotificationService.RequestBrowserNotificationPermissionAsync();
            await CheckNotificationPermission();

            if (granted)
            {
                saveMessage = "通知が許可されました";
                saveSuccess = true;
            }
            else
            {
                saveMessage = "通知が拒否されました";
                saveSuccess = false;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"エラー: {ex.Message}";
            saveSuccess = false;
        }
    }

    private async Task OpenBrowserNotificationSettings()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.openNotificationSettings");
        }
        catch (Exception ex)
        {
            saveMessage = $"エラー: {ex.Message}";
            saveSuccess = false;
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            // 設定値の検証
            if (thresholdSeconds < 0)
            {
                saveMessage = "通知時間は0以上にしてください";
                saveSuccess = false;
                return;
            }

            if (webHookEnabled && string.IsNullOrWhiteSpace(webHookUrl))
            {
                saveMessage = "WebHook URLを入力してください";
                saveSuccess = false;
                return;
            }

            // LocalStorageに設定を保存
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateNotificationSettings",
                browserNotificationEnabled, thresholdSeconds);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateWebhookSettings",
                webHookEnabled, webHookUrl, null);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateClaudeHookSettings",
                claudeHookEnabled, hookEventStop, hookEventUserPromptSubmit, hookEventNotification);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateSpecialSettings",
                claudeModeSwitchKey);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateSessionSettings",
                sessionSortMode);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateDevToolsSettings",
                devToolsEnabled);

            // サーバー側のWebhook設定も保存（Hook通知用）
            WebhookSettingsService.SaveSettings(new WebhookSettings
            {
                Enabled = webHookEnabled,
                Url = webHookUrl ?? ""
            });

            // セッションソートモードの変更を通知
            await OnSessionSortModeChanged.InvokeAsync(sessionSortMode);

            saveMessage = "設定を保存しました";
            saveSuccess = true;

            // 3秒後にメッセージを消す
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                await InvokeAsync(() =>
                {
                    saveMessage = "";
                    StateHasChanged();
                });
            });
        }
        catch (Exception ex)
        {
            saveMessage = $"保存エラー: {ex.Message}";
            saveSuccess = false;
        }
    }
    
    private string GetNotificationBadgeClass()
    {
        return notificationStatus switch
        {
            "許可済み" => "bg-success",
            "拒否" => "bg-danger",
            "未許可" => "bg-warning",
            _ => "bg-secondary"
        };
    }
    
    private async Task Close()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
    
    private async Task ExportSettings()
    {
        try
        {
            var exportData = new Dictionary<string, object>();
            
            if (exportCategories.notifications)
            {
                var settings = await JSRuntime.InvokeAsync<object>("terminalHubHelpers.getSettings");
                if (settings != null)
                {
                    exportData["notifications"] = settings;
                }
            }
            
            if (exportCategories.sessions)
            {
                var sessions = await LocalStorageService.GetAsync<object>("terminalHub_sessions");
                if (sessions != null)
                {
                    exportData["sessions"] = sessions;
                }
                
                var activeSession = await LocalStorageService.GetAsync<object>("terminalHub_activeSession");
                if (activeSession != null)
                {
                    exportData["activeSession"] = activeSession;
                }
            }
            
            if (exportCategories.ui)
            {
                var devWindowPos = await LocalStorageService.GetAsync<object>("devWindowPosition");
                if (devWindowPos != null)
                {
                    exportData["devWindowPosition"] = devWindowPos;
                }
            }
            
            if (exportCategories.history)
            {
                var history = await LocalStorageService.GetAsync<object>("inputHistory");
                if (history != null)
                {
                    exportData["inputHistory"] = history;
                }
            }
            
            // メタデータを追加
            exportData["_metadata"] = new
            {
                exportedAt = DateTime.Now,
                version = "1.0"
            };
            
            // JSONに変換してダウンロード
            var json = System.Text.Json.JsonSerializer.Serialize(exportData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });
            
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.downloadJson", 
                json, $"terminalhub_export_{DateTime.Now:yyyyMMdd_HHmmss}.json");
            
            saveMessage = "エクスポートが完了しました";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"エクスポートエラー: {ex.Message}";
            saveSuccess = false;
        }
    }
    
    private async Task LoadImportFile(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file.ContentType != "application/json")
            {
                saveMessage = "JSONファイルを選択してください";
                saveSuccess = false;
                return;
            }
            
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            
            importData = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, object>>(json);
            if (importData != null)
            {
                importPreview = importData.Keys.Where(k => k != "_metadata").ToList();
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"ファイル読み込みエラー: {ex.Message}";
            saveSuccess = false;
            importPreview = null;
            importData = null;
        }
    }
    
    private async Task ImportSettings()
    {
        if (importData == null) return;
        
        try
        {
            foreach (var kvp in importData.Where(k => k.Key != "_metadata"))
            {
                switch (kvp.Key)
                {
                    case "notifications":
                        await JSRuntime.InvokeVoidAsync("terminalHubHelpers.saveSettings", kvp.Value);
                        break;
                    case "sessions":
                        await LocalStorageService.SetAsync("terminalHub_sessions", kvp.Value);
                        break;
                    case "activeSession":
                        await LocalStorageService.SetAsync("terminalHub_activeSession", kvp.Value);
                        break;
                    case "devWindowPosition":
                        await LocalStorageService.SetAsync("devWindowPosition", kvp.Value);
                        break;
                    case "inputHistory":
                        await LocalStorageService.SetAsync("inputHistory", kvp.Value);
                        break;
                }
            }
            
            saveMessage = "インポートが完了しました。ページを再読み込みしてください。";
            saveSuccess = true;
            importPreview = null;
            importData = null;
        }
        catch (Exception ex)
        {
            saveMessage = $"インポートエラー: {ex.Message}";
            saveSuccess = false;
        }
    }
    
    private string GetCategoryDisplayName(string category)
    {
        return category switch
        {
            "notifications" => "通知設定",
            "sessions" => "セッション情報",
            "activeSession" => "アクティブセッション",
            "devWindowPosition" => "開発ウィンドウ位置",
            "inputHistory" => "入力履歴",
            _ => category
        };
    }

    // 開発ツール関連メソッド
    private async Task RefreshDiagnostics()
    {
        try
        {
            diagnosticSessions = SessionManager.GetAllSessions().ToList();
            jsTerminalCount = await JSRuntime.InvokeAsync<int>("terminalHubHelpers.getTerminalCount");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"診断情報取得エラー: {ex.Message}");
        }
    }

    private async Task RunJSDiagnostics()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.diagnoseTerminals");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JS診断エラー: {ex.Message}");
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.scrollAllTerminalsToBottom");
            scrollInfo = $"最下部にスクロールしました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            scrollInfo = $"エラー: {ex.Message}";
        }
    }

    private async Task ScrollToTop()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.scrollAllTerminalsToTop");
            scrollInfo = $"最上部にスクロールしました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            scrollInfo = $"エラー: {ex.Message}";
        }
    }

    private async Task GetScrollPosition()
    {
        try
        {
            var result = await JSRuntime.InvokeAsync<object>("terminalHubHelpers.getAllTerminalScrollPositions");
            scrollInfo = $"スクロール位置: {System.Text.Json.JsonSerializer.Serialize(result)} - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            scrollInfo = $"エラー: {ex.Message}";
        }
    }

    private IEnumerable<SessionInfo> GetAvailableSessions()
    {
        return SessionManager.GetAllSessions();
    }

    private SessionInfo? GetSelectedBufferSession()
    {
        if (string.IsNullOrEmpty(selectedSessionForBuffer) || !Guid.TryParse(selectedSessionForBuffer, out var sessionId))
            return null;
        return SessionManager.GetSessionInfo(sessionId);
    }

    private void StartCapture()
    {
        var session = GetSelectedBufferSession();
        if (session == null)
        {
            bufferResult = "セッションを選択してください";
            return;
        }
        session.StartBufferCapture();
        bufferResult = $"キャプチャを開始しました - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private void StopCapture()
    {
        var session = GetSelectedBufferSession();
        if (session == null)
        {
            bufferResult = "セッションを選択してください";
            return;
        }
        session.StopBufferCapture();
        bufferResult = $"キャプチャを停止しました - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private void ClearBuffer()
    {
        var session = GetSelectedBufferSession();
        if (session == null)
        {
            bufferResult = "セッションを選択してください";
            return;
        }
        session.ClearCapturedBuffer();
        bufferResult = $"バッファをクリアしました - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private async Task DownloadBuffer()
    {
        try
        {
            var sessionInfo = GetSelectedBufferSession();
            if (sessionInfo == null)
            {
                bufferResult = "セッションを選択してください";
                return;
            }

            var content = sessionInfo.GetCapturedBuffer();
            if (string.IsNullOrEmpty(content))
            {
                bufferResult = "バッファが空です";
                return;
            }

            var bufferInfo = new
            {
                Status = sessionInfo.EnableBufferCapture ? "キャプチャ中" : "停止中",
                BufferSize = content.Length,
                LineCount = content.Split('\n').Length,
                CaptureStartTime = sessionInfo.BufferCaptureStartTime?.ToString("yyyy-MM-dd HH:mm:ss"),
                SessionName = sessionInfo.GetDisplayName(),
                SessionId = sessionInfo.SessionId
            };

            var header = "--- バッファ情報 ---\n" + System.Text.Json.JsonSerializer.Serialize(bufferInfo, new System.Text.Json.JsonSerializerOptions { WriteIndented = true }) + "\n\n--- バッファ内容 ---\n";
            var fullContent = header + content;
            var filename = $"buffer_{SanitizeFilename(sessionInfo.GetDisplayName())}_{DateTime.Now:yyyyMMdd_HHmmss}.txt";

            var bytes = System.Text.Encoding.UTF8.GetBytes(fullContent);
            var base64 = Convert.ToBase64String(bytes);

            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.downloadBase64File", base64, filename, "text/plain");

            bufferResult = $"ダウンロード完了: {filename} ({FormatBytes(content.Length)})";
        }
        catch (Exception ex)
        {
            bufferResult = $"エラー: {ex.Message}";
        }
    }

    private string FormatBytes(int bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private string SanitizeFilename(string filename)
    {
        var invalidChars = Path.GetInvalidFileNameChars();
        var sanitized = filename;
        foreach (var c in invalidChars)
        {
            sanitized = sanitized.Replace(c, '_');
        }
        return sanitized;
    }

    private async Task TestBrowserNotification()
    {
        try
        {
            var testSession = new SessionInfo
            {
                SessionId = Guid.NewGuid(),
                FolderPath = "C:\\TestFolder",
                DisplayName = "通知テストセッション",
                TerminalType = TerminalType.ClaudeCode,
                ProcessingElapsedSeconds = testElapsedSeconds
            };

            notificationTestResult = $"ブラウザ通知を送信中... ({testElapsedSeconds}秒の処理として)";
            StateHasChanged();

            await NotificationService.NotifyProcessingCompleteAsync(testSession, testElapsedSeconds);

            notificationTestResult = $"ブラウザ通知を送信しました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            notificationTestResult = $"エラー: {ex.Message}";
        }
    }

    private async Task TestWebHookNotification()
    {
        try
        {
            var testSession = new SessionInfo
            {
                SessionId = Guid.NewGuid(),
                FolderPath = "C:\\TestFolder",
                DisplayName = "WebHookテストセッション",
                TerminalType = TerminalType.GeminiCLI,
                ProcessingElapsedSeconds = testElapsedSeconds
            };

            notificationTestResult = $"WebHook通知を送信中... ({testElapsedSeconds}秒の処理として)";
            StateHasChanged();

            await NotificationService.NotifyProcessingCompleteAsync(testSession, testElapsedSeconds);

            notificationTestResult = $"WebHook通知を送信しました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            notificationTestResult = $"エラー: {ex.Message}";
        }
    }
}