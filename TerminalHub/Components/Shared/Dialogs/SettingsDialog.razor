@namespace TerminalHub.Components.Shared.Dialogs
@using TerminalHub.Services
@using TerminalHub.Models
@using Microsoft.Extensions.Configuration
@inject INotificationService NotificationService
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorageService
@inject IWebhookSettingsService WebhookSettingsService
@inject ISessionManager SessionManager
@inject IStorageServiceFactory StorageServiceFactory

@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear-fill me-2"></i>設定
                    </h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- タブナビゲーション -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "general" ? "active" : "")" 
                                    type="button" 
                                    @onclick="@(() => activeTab = "general")">
                                <i class="bi bi-gear me-1"></i>一般
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "notifications" ? "active" : "")" 
                                    type="button" 
                                    @onclick="@(() => activeTab = "notifications")">
                                <i class="bi bi-bell me-1"></i>通知
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "sessions" ? "active" : "")"
                                    type="button"
                                    @onclick="@(() => activeTab = "sessions")">
                                <i class="bi bi-terminal me-1"></i>セッション
                            </button>
                        </li>
                        @if (showMigrationTab)
                        {
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "migration" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "migration")">
                                    <i class="bi bi-database me-1"></i>データ移行
                                </button>
                            </li>
                        }
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "export" ? "active" : "")"
                                    type="button"
                                    @onclick="@(() => activeTab = "export")">
                                <i class="bi bi-download me-1"></i>エクスポート/インポート
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "special" ? "active" : "")"
                                    type="button"
                                    @onclick="@(() => activeTab = "special")">
                                <i class="bi bi-wrench me-1"></i>特殊
                            </button>
                        </li>
                        @if (devToolsEnabled)
                        {
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "devDiagnose" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "devDiagnose")">
                                    <i class="bi bi-bug me-1"></i>診断
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "devBuffer" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "devBuffer")">
                                    <i class="bi bi-hdd me-1"></i>バッファ
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(activeTab == "devNotify" ? "active" : "")"
                                        type="button"
                                        @onclick="@(() => activeTab = "devNotify")">
                                    <i class="bi bi-bell-fill me-1"></i>通知テスト
                                </button>
                            </li>
                        }
                    </ul>
                    
                    <!-- タブコンテンツ -->
                    <div class="tab-content">
                        @if (activeTab == "general")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">一般設定</h6>

                                <div class="mb-4">
                                    <label class="form-label">デフォルトフォルダパス</label>
                                    <input type="text" class="form-control @(defaultFolderPathWarning != null ? "is-warning" : "")"
                                           @bind="defaultFolderPath"
                                           placeholder="@Environment.GetFolderPath(Environment.SpecialFolder.UserProfile)" />
                                    @if (defaultFolderPathWarning != null)
                                    {
                                        <div class="text-warning small mt-1">
                                            <i class="bi bi-exclamation-triangle me-1"></i>@defaultFolderPathWarning
                                        </div>
                                    }
                                    <small class="text-muted">
                                        新規セッション作成時のデフォルトパスを設定します。空欄の場合はユーザーフォルダが使用されます。
                                    </small>
                                </div>
                            </div>
                        }
                        else if (activeTab == "notifications")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">通知設定</h6>
                    
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <label class="form-label mb-0">ブラウザ通知</label>
                            <span class="badge @GetNotificationBadgeClass()">@notificationStatus</span>
                        </div>
                        @if (notificationStatus == "許可済み")
                        {
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" @bind="browserNotificationEnabled" id="browserNotificationSwitch">
                                <label class="form-check-label" for="browserNotificationSwitch">
                                    ブラウザ通知を有効にする
                                </label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="OpenBrowserNotificationSettings">
                                <i class="bi bi-gear me-1"></i>通知許可を解除
                            </button>
                            <p class="text-muted small mt-2 mb-0">
                                ブラウザの設定画面で通知許可を解除できます。
                            </p>
                        }
                        else if (notificationStatus == "未許可")
                        {
                            <button class="btn btn-primary btn-sm" @onclick="RequestNotificationPermission">
                                <i class="bi bi-bell me-1"></i>通知を許可する
                            </button>
                            <p class="text-muted small mt-2 mb-0">
                                処理完了時にデスクトップ通知を受け取るには、ブラウザの通知を許可してください。
                            </p>
                        }
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">通知を送信する処理時間（秒）</label>
                        <input type="number" class="form-control" @bind="thresholdSeconds" min="0" max="3600" />
                        <small class="text-muted">0に設定すると、すべての処理完了時に通知します</small>
                    </div>
                    
                    <hr />
                    
                    <h6 class="mb-3">WebHook設定</h6>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="webHookEnabled" id="webHookSwitch">
                            <label class="form-check-label" for="webHookSwitch">
                                WebHook通知を有効にする
                            </label>
                        </div>
                    </div>
                    
                    @if (webHookEnabled)
                    {
                        <div class="mb-3">
                            <label class="form-label">WebHook URL</label>
                            <input type="url" class="form-control" @bind="webHookUrl" placeholder="https://example.com/webhook" />
                        </div>
                    }

                    <hr />

                    <h6 class="mb-3">Claude Code Hook設定</h6>
                    <p class="text-muted small mb-3">
                        Claude Code の hook 機能を使用して、より確実に通知を受け取ることができます。
                        セッション作成時に自動的に <code>.claude/settings.local.json</code> に設定が追加されます。
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="claudeHookEnabled" id="claudeHookSwitch">
                            <label class="form-check-label" for="claudeHookSwitch">
                                Claude Code Hook を有効にする
                            </label>
                        </div>
                    </div>

                    @if (claudeHookEnabled)
                    {
                        <div class="mb-3">
                            <label class="form-label">通知するイベント</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="hookEventStop" id="hookEventStop">
                                <label class="form-check-label" for="hookEventStop">
                                    Stop（処理完了時）
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="hookEventUserPromptSubmit" id="hookEventUserPromptSubmit">
                                <label class="form-check-label" for="hookEventUserPromptSubmit">
                                    UserPromptSubmit（ユーザー入力時）
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="hookEventNotification" id="hookEventNotification">
                                <label class="form-check-label" for="hookEventNotification">
                                    Notification（通知発生時）
                                </label>
                            </div>
                        </div>
                    }
                            </div>
                        }
                        else if (activeTab == "sessions")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">セッション設定</h6>

                                <div class="mb-4">
                                    <label class="form-label">セッション一覧の並び順</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sessionSortMode"
                                               id="sortByCreatedAt" value="createdAt" checked="@(sessionSortMode == "createdAt")"
                                               @onchange="@(() => sessionSortMode = "createdAt")">
                                        <label class="form-check-label" for="sortByCreatedAt">
                                            <i class="bi bi-calendar-plus me-1"></i>作成日時順
                                            <span class="text-muted small">（デフォルト）</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sessionSortMode"
                                               id="sortByLastAccessed" value="lastAccessed" checked="@(sessionSortMode == "lastAccessed")"
                                               @onchange="@(() => sessionSortMode = "lastAccessed")">
                                        <label class="form-check-label" for="sortByLastAccessed">
                                            <i class="bi bi-clock-history me-1"></i>最終利用日時順
                                            <span class="text-muted small">（最近使用したセッションが上に表示）</span>
                                        </label>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        「最終利用日時順」では、子セッション（Worktree）の利用も親セッションの順序に反映されます。
                                    </p>
                                </div>

                                <hr />

                                <div class="mb-4">
                                    <label class="form-label">セッション一覧の表示設定</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="showTerminalType" id="showTerminalType">
                                        <label class="form-check-label" for="showTerminalType">
                                            <i class="bi bi-tag me-1"></i>ターミナル種別を表示
                                            <span class="text-muted small">（Claude/Gemini/Codexバッジ）</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="showGitInfo" id="showGitInfo">
                                        <label class="form-check-label" for="showGitInfo">
                                            <i class="bi bi-git me-1"></i>Git情報を表示
                                            <span class="text-muted small">（ブランチ名バッジ）</span>
                                        </label>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        セッション一覧に表示する追加情報を選択できます。
                                    </p>
                                </div>
                            </div>
                        }
                        else if (activeTab == "migration")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">データ移行</h6>

                                <div class="mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="me-2">現在のデータ保存先:</span>
                                        <span class="badge @(currentStorageType == StorageType.SQLite ? "bg-success" : "bg-warning")">
                                            @(currentStorageType == StorageType.SQLite ? "SQLite" : "LocalStorage")
                                        </span>
                                    </div>

                                    @if (currentStorageType == StorageType.SQLite)
                                    {
                                        <div class="alert alert-success">
                                            <i class="bi bi-check-circle me-1"></i>
                                            現在SQLiteを使用しています
                                        </div>

                                        <div class="mb-3">
                                            <p class="mb-1">SQLiteセッション数: <strong>@sqliteSessionCount</strong>件</p>
                                            <p class="mb-1">データベースパス:</p>
                                            <code class="small">@sqliteDbPath</code>
                                        </div>
                                    }

                                    @if (localStorageSessionCount > 0)
                                    {
                                        <div class="@(currentStorageType == StorageType.SQLite ? "mt-4 pt-3 border-top" : "")">
                                            <h6 class="mb-2">
                                                <i class="bi bi-hdd me-1"></i>LocalStorageのデータ
                                            </h6>
                                            <div class="mb-3">
                                                <p class="mb-1">セッション数: <strong>@localStorageSessionCount</strong>件</p>
                                                <p class="mb-1">データサイズ: 約 <strong>@FormatBytes(localStorageDataSize)</strong></p>
                                            </div>

                                            @if (currentStorageType == StorageType.LocalStorage)
                                            {
                                                <div class="alert alert-info">
                                                    <h6 class="alert-heading"><i class="bi bi-info-circle me-1"></i>SQLiteに移行すると</h6>
                                                    <ul class="mb-0 small">
                                                        <li>セッション切り替えが高速化</li>
                                                        <li>データの部分更新が可能に</li>
                                                        <li>アプリ再インストール時もデータ保持</li>
                                                    </ul>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-warning">
                                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                                    再移行するとSQLiteの現在のデータが上書きされます
                                                </div>
                                            }

                                            <button class="btn @(currentStorageType == StorageType.SQLite ? "btn-warning" : "btn-primary")"
                                                    @onclick="MigrateToSqlite" disabled="@isMigrating">
                                                @if (isMigrating)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                    <span>移行中...</span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-database-fill-up me-1"></i>
                                                    <span>@(currentStorageType == StorageType.SQLite ? "LocalStorageから再移行" : "SQLiteに移行する")</span>
                                                }
                                            </button>

                                            <p class="text-muted small mt-2">
                                                <i class="bi bi-info-circle me-1"></i>
                                                移行後もLocalStorageのデータはバックアップとして残ります
                                            </p>
                                        </div>
                                    }
                                    else if (currentStorageType == StorageType.LocalStorage)
                                    {
                                        <div class="alert alert-secondary">
                                            <i class="bi bi-info-circle me-1"></i>
                                            LocalStorageにセッションデータがありません
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else if (activeTab == "export")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">データのエクスポート/インポート</h6>

                                <!-- エクスポート -->
                                <div class="mb-4">
                                    <h6 class="mb-2">エクスポート</h6>
                                    <p class="text-muted small">
                                        現在のストレージ（@(currentStorageType == StorageType.SQLite ? "SQLite" : "LocalStorage")）からセッション情報をJSONファイルとしてダウンロードします。
                                    </p>

                                    <div class="alert alert-secondary mb-3">
                                        <small>
                                            <i class="bi bi-info-circle me-1"></i>
                                            エクスポート対象: セッション情報（@currentStorageSessionCount 件）
                                        </small>
                                    </div>

                                    <button class="btn btn-primary btn-sm" @onclick="ExportSettings" disabled="@(currentStorageSessionCount == 0)">
                                        <i class="bi bi-download me-1"></i>エクスポート
                                    </button>
                                </div>

                                <hr />

                                <!-- インポート -->
                                <div>
                                    <h6 class="mb-2">インポート</h6>
                                    <p class="text-muted small">
                                        JSONファイルを選択してセッション情報をインポートします。
                                        現在のストレージ（@(currentStorageType == StorageType.SQLite ? "SQLite" : "LocalStorage")）に追加されます。
                                    </p>

                                    <div class="mb-3">
                                        <InputFile OnChange="@LoadImportFile" accept=".json" class="form-control" />
                                    </div>

                                    @if (importSessionCount > 0)
                                    {
                                        <div class="alert alert-info">
                                            <h6 class="alert-heading">インポートプレビュー</h6>
                                            <small>
                                                <i class="bi bi-terminal me-1"></i>セッション情報: @importSessionCount 件
                                            </small>
                                        </div>

                                        <button class="btn btn-warning btn-sm" @onclick="ImportSettings">
                                            <i class="bi bi-upload me-1"></i>インポート実行
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        else if (activeTab == "special")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">特殊設定</h6>

                                <div class="mb-4">
                                    <h6 class="mb-2">Claude Code モード切替キー</h6>
                                    <p class="text-muted small">Claude Codeでモード切替に使用するキーボードショートカットを選択します。</p>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="claudeModeSwitchKey"
                                                   id="keyAltM" value="altM" checked="@(claudeModeSwitchKey == "altM")"
                                                   @onchange="@(() => claudeModeSwitchKey = "altM")">
                                            <label class="form-check-label" for="keyAltM">
                                                <kbd>Alt+M</kbd> <span class="text-muted">（デフォルト）</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="claudeModeSwitchKey"
                                                   id="keyShiftTab" value="shiftTab" checked="@(claudeModeSwitchKey == "shiftTab")"
                                                   @onchange="@(() => claudeModeSwitchKey = "shiftTab")">
                                            <label class="form-check-label" for="keyShiftTab">
                                                <kbd>Shift+Tab</kbd>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="claudeModeSwitchKey"
                                                   id="keyPlan" value="plan" checked="@(claudeModeSwitchKey == "plan")"
                                                   @onchange="@(() => claudeModeSwitchKey = "plan")">
                                            <label class="form-check-label" for="keyPlan">
                                                <kbd>/plan</kbd> <span class="text-muted">（コマンド送信）</span>
                                            </label>
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        環境によってはAlt+Mが他の機能と競合する場合があります。その場合はShift+Tabをお試しください。<br/>
                                        <code>/plan</code>を選択すると、ボタンクリック時に/planコマンドを送信してPlanモードに入ります。
                                    </p>
                                </div>

                                <hr />

                                <div class="mb-4">
                                    <h6 class="mb-2">開発ツール</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" @bind="devToolsEnabled" id="devToolsSwitch">
                                        <label class="form-check-label" for="devToolsSwitch">
                                            開発ツールを有効にする
                                        </label>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        有効にすると、診断・バッファ・通知テストのタブが表示されます。
                                    </p>
                                </div>

                                <hr />

                                <div class="mb-4">
                                    <h6 class="mb-2">ログファイル</h6>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="OpenLogFolder">
                                        <i class="bi bi-folder2-open me-1"></i>ログフォルダを開く
                                    </button>
                                    <p class="text-muted small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        アプリケーションのログファイルが保存されているフォルダを開きます。
                                    </p>
                                </div>
                            </div>
                        }
                        else if (activeTab == "devDiagnose")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">診断情報</h6>

                                <div class="mb-3">
                                    <button class="btn btn-info btn-sm me-2" @onclick="RefreshDiagnostics">
                                        <i class="bi bi-arrow-clockwise me-1"></i>診断情報を更新
                                    </button>
                                    <button class="btn btn-warning btn-sm" @onclick="RunJSDiagnostics">
                                        <i class="bi bi-bug me-1"></i>JS診断実行
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <h6>セッション一覧</h6>
                                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>名前</th>
                                                    <th>状態</th>
                                                    <th>ConPTY</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var session in diagnosticSessions)
                                                {
                                                    <tr>
                                                        <td class="text-truncate" style="max-width: 150px;">@session.GetDisplayName()</td>
                                                        <td>
                                                            <span class="badge @(session.IsActive ? "bg-success" : "bg-secondary")">
                                                                @(session.IsActive ? "Active" : "Inactive")
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="badge @(session.ConPtySession != null ? "bg-primary" : "bg-warning")">
                                                                @(session.ConPtySession != null ? "有" : "無")
                                                            </span>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6>ターミナル情報</h6>
                                    <p class="mb-1">JavaScript側ターミナル数: <span class="badge bg-info">@jsTerminalCount</span></p>
                                </div>

                                <hr />

                                <h6 class="mb-3">ターミナル制御テスト</h6>
                                <div class="mb-3">
                                    <button class="btn btn-primary btn-sm me-2" @onclick="ScrollToBottom">
                                        <i class="bi bi-arrow-down me-1"></i>最下部へ
                                    </button>
                                    <button class="btn btn-secondary btn-sm me-2" @onclick="ScrollToTop">
                                        <i class="bi bi-arrow-up me-1"></i>最上部へ
                                    </button>
                                    <button class="btn btn-info btn-sm" @onclick="GetScrollPosition">
                                        <i class="bi bi-info-circle me-1"></i>位置取得
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">@scrollInfo</small>
                                </div>
                            </div>
                        }
                        else if (activeTab == "devBuffer")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">バッファキャプチャ</h6>

                                <div class="mb-3">
                                    <label class="form-label">セッション選択</label>
                                    <select class="form-select" @bind="selectedSessionForBuffer">
                                        <option value="">-- セッションを選択 --</option>
                                        @foreach (var session in GetAvailableSessions())
                                        {
                                            var captureStatus = session.EnableBufferCapture ? " [キャプチャ中]" : "";
                                            var bufferSize = session.CapturedBufferSize > 0 ? $" ({FormatBytes(session.CapturedBufferSize)})" : "";
                                            <option value="@session.SessionId">@session.GetDisplayName()@captureStatus@bufferSize</option>
                                        }
                                    </select>
                                </div>

                                @if (GetSelectedBufferSession() is SessionInfo selectedSession)
                                {
                                    <div class="mb-3">
                                        <span class="badge @(selectedSession.EnableBufferCapture ? "bg-success" : "bg-secondary") me-2">
                                            @(selectedSession.EnableBufferCapture ? "キャプチャ中" : "停止中")
                                        </span>
                                        @if (selectedSession.CapturedBufferSize > 0)
                                        {
                                            <span class="badge bg-info">@FormatBytes(selectedSession.CapturedBufferSize)</span>
                                        }
                                    </div>
                                }

                                <div class="mb-3">
                                    <div class="btn-group me-2">
                                        <button class="btn btn-success btn-sm" @onclick="StartCapture"
                                                disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.EnableBufferCapture == true)">
                                            <i class="bi bi-record-circle me-1"></i>開始
                                        </button>
                                        <button class="btn btn-warning btn-sm" @onclick="StopCapture"
                                                disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.EnableBufferCapture != true)">
                                            <i class="bi bi-stop-circle me-1"></i>停止
                                        </button>
                                        <button class="btn btn-danger btn-sm" @onclick="ClearBuffer"
                                                disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.CapturedBufferSize == 0)">
                                            <i class="bi bi-trash me-1"></i>クリア
                                        </button>
                                    </div>
                                    <button class="btn btn-primary btn-sm" @onclick="DownloadBuffer"
                                            disabled="@(string.IsNullOrEmpty(selectedSessionForBuffer) || GetSelectedBufferSession()?.CapturedBufferSize == 0)">
                                        <i class="bi bi-download me-1"></i>ダウンロード
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">@bufferResult</small>
                                </div>
                            </div>
                        }
                        else if (activeTab == "devNotify")
                        {
                            <div class="tab-pane fade show active">
                                <h6 class="mb-3">通知テスト</h6>

                                <div class="mb-3">
                                    <label class="form-label">テスト用経過時間（秒）</label>
                                    <input type="number" class="form-control" @bind="testElapsedSeconds" min="1" max="300" style="max-width: 150px;" />
                                </div>

                                <div class="mb-3">
                                    <button class="btn btn-warning btn-sm me-2" @onclick="TestBrowserNotification">
                                        <i class="bi bi-bell me-1"></i>ブラウザ通知テスト
                                    </button>
                                    <button class="btn btn-success btn-sm" @onclick="TestWebHookNotification">
                                        <i class="bi bi-send me-1"></i>WebHook通知テスト
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">@notificationTestResult</small>
                                </div>
                            </div>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(saveMessage))
                    {
                        <div class="alert @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
                            @saveMessage
                            <button type="button" class="btn-close" @onclick="() => saveMessage = string.Empty"></button>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">キャンセル</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSettings">
                        <i class="bi bi-save me-1"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    private string notificationStatus = "確認中...";
    private int thresholdSeconds = 60;
    private bool browserNotificationEnabled = true;
    private bool webHookEnabled = false;
    private string webHookUrl = "";
    private bool claudeHookEnabled = true;
    private bool hookEventStop = true;
    private bool hookEventUserPromptSubmit = true;
    private bool hookEventNotification = true;
    private string saveMessage = "";
    private bool saveSuccess = false;
    private string activeTab = "notifications";
    private string claudeModeSwitchKey = "altM";
    private string sessionSortMode = "createdAt";
    private bool showTerminalType = false;
    private bool showGitInfo = false;
    private string defaultFolderPath = "";
    private string? defaultFolderPathWarning = null;

    // 開発ツール関連
    private bool devToolsEnabled = false;
    private List<SessionInfo> diagnosticSessions = new();
    private int jsTerminalCount = 0;
    private string scrollInfo = "スクロール位置情報が表示されます";
    private string selectedSessionForBuffer = "";
    private string bufferResult = "";
    private int testElapsedSeconds = 10;
    private string notificationTestResult = "テスト結果がここに表示されます";

    // データ移行関連
    private bool showMigrationTab = false;
    private StorageType currentStorageType = StorageType.LocalStorage;
    private int localStorageSessionCount = 0;
    private int localStorageDataSize = 0;
    private int sqliteSessionCount = 0;
    private string sqliteDbPath = "";
    private bool isMigrating = false;

    [Parameter] public EventCallback<string> OnSessionSortModeChanged { get; set; }
    [Parameter] public string SessionSortMode { get; set; } = "createdAt";
    [Parameter] public EventCallback<string> OnClaudeModeSwitchKeyChanged { get; set; }
    [Parameter] public EventCallback<(bool showTerminalType, bool showGitInfo)> OnSessionDisplaySettingsChanged { get; set; }

    // ダイアログが開いている間は設定を再読み込みしないためのフラグ
    private bool _settingsLoaded = false;

    // エクスポート/インポート用
    private int currentStorageSessionCount = 0;
    private int importSessionCount = 0;
    private List<SessionInfo>? importSessions = null;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !_settingsLoaded)
        {
            // ダイアログが開かれた時のみ設定を読み込む
            await LoadSettings();
            await CheckNotificationPermission();
            _settingsLoaded = true;
        }
        else if (!IsVisible && _settingsLoaded)
        {
            // ダイアログが閉じられたらフラグをリセット（次回開いた時に再読み込み）
            _settingsLoaded = false;
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            // データ移行タブの状態を更新
            await LoadMigrationTabState();

            // LocalStorageから設定を読み込み
            var settings = await JSRuntime.InvokeAsync<System.Text.Json.JsonElement?>("terminalHubHelpers.getSettings");
            if (settings.HasValue)
            {
                var s = settings.Value;
                if (s.TryGetProperty("notifications", out var notifications))
                {
                    if (notifications.TryGetProperty("enableBrowserNotifications", out var enabled))
                    {
                        browserNotificationEnabled = enabled.GetBoolean();
                    }
                    if (notifications.TryGetProperty("processingTimeThresholdSeconds", out var threshold))
                    {
                        thresholdSeconds = threshold.GetInt32();
                    }
                }
                if (s.TryGetProperty("webhook", out var webhook))
                {
                    if (webhook.TryGetProperty("enabled", out var enabled))
                    {
                        webHookEnabled = enabled.GetBoolean();
                    }
                    if (webhook.TryGetProperty("url", out var url))
                    {
                        webHookUrl = url.GetString() ?? "";
                    }
                }
                if (s.TryGetProperty("claudeHook", out var claudeHook))
                {
                    if (claudeHook.TryGetProperty("enabled", out var hookEnabled))
                    {
                        claudeHookEnabled = hookEnabled.GetBoolean();
                    }
                    if (claudeHook.TryGetProperty("events", out var events))
                    {
                        if (events.TryGetProperty("stop", out var stop))
                        {
                            hookEventStop = stop.GetBoolean();
                        }
                        if (events.TryGetProperty("userPromptSubmit", out var userPrompt))
                        {
                            hookEventUserPromptSubmit = userPrompt.GetBoolean();
                        }
                        if (events.TryGetProperty("notification", out var notif))
                        {
                            hookEventNotification = notif.GetBoolean();
                        }
                    }
                }
                if (s.TryGetProperty("special", out var special))
                {
                    if (special.TryGetProperty("claudeModeSwitchKey", out var key))
                    {
                        claudeModeSwitchKey = key.GetString() ?? "altM";
                    }
                }
                if (s.TryGetProperty("sessions", out var sessionsSettings))
                {
                    if (sessionsSettings.TryGetProperty("sortMode", out var sortMode))
                    {
                        sessionSortMode = sortMode.GetString() ?? "createdAt";
                    }
                    if (sessionsSettings.TryGetProperty("showTerminalType", out var showTermType))
                    {
                        showTerminalType = showTermType.GetBoolean();
                    }
                    if (sessionsSettings.TryGetProperty("showGitInfo", out var showGit))
                    {
                        showGitInfo = showGit.GetBoolean();
                    }
                }
                if (s.TryGetProperty("devTools", out var devTools))
                {
                    if (devTools.TryGetProperty("enabled", out var enabled))
                    {
                        devToolsEnabled = enabled.GetBoolean();
                    }
                }
                if (s.TryGetProperty("general", out var general))
                {
                    if (general.TryGetProperty("defaultFolderPath", out var path))
                    {
                        defaultFolderPath = path.GetString() ?? "";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"設定読み込みエラー: {ex.Message}");
            // デフォルト値を使用
            thresholdSeconds = 5;
            webHookEnabled = false;
            webHookUrl = "";
            claudeModeSwitchKey = "altM";
            sessionSortMode = "createdAt";
            showTerminalType = false;
            showGitInfo = false;
            devToolsEnabled = false;
            defaultFolderPath = "";
        }
    }
    
    private async Task CheckNotificationPermission()
    {
        try
        {
            var permission = await JSRuntime.InvokeAsync<string>("terminalHubHelpers.checkNotificationPermission");
            notificationStatus = permission switch
            {
                "granted" => "許可済み",
                "denied" => "拒否",
                "default" => "未許可",
                _ => "不明"
            };
        }
        catch
        {
            notificationStatus = "確認エラー";
        }
    }
    
    private async Task RequestNotificationPermission()
    {
        try
        {
            var granted = await NotificationService.RequestBrowserNotificationPermissionAsync();
            await CheckNotificationPermission();

            if (granted)
            {
                saveMessage = "通知が許可されました";
                saveSuccess = true;
            }
            else
            {
                saveMessage = "通知が拒否されました";
                saveSuccess = false;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"エラー: {ex.Message}";
            saveSuccess = false;
        }
    }

    private async Task OpenBrowserNotificationSettings()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.openNotificationSettings");
        }
        catch (Exception ex)
        {
            saveMessage = $"エラー: {ex.Message}";
            saveSuccess = false;
        }
    }

    private void OpenLogFolder()
    {
        try
        {
            var logPath = Path.Combine(AppContext.BaseDirectory, "logs");
            if (!Directory.Exists(logPath))
            {
                Directory.CreateDirectory(logPath);
            }
            System.Diagnostics.Process.Start("explorer.exe", logPath);
        }
        catch (Exception ex)
        {
            saveMessage = $"フォルダを開けませんでした: {ex.Message}";
            saveSuccess = false;
            StateHasChanged();
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            // 設定値の検証
            if (thresholdSeconds < 0)
            {
                saveMessage = "通知時間は0以上にしてください";
                saveSuccess = false;
                return;
            }

            if (webHookEnabled && string.IsNullOrWhiteSpace(webHookUrl))
            {
                saveMessage = "WebHook URLを入力してください";
                saveSuccess = false;
                return;
            }

            // デフォルトフォルダパスの正規化と検証
            defaultFolderPathWarning = null;
            if (!string.IsNullOrWhiteSpace(defaultFolderPath))
            {
                // パス区切りをバックスラッシュに統一
                defaultFolderPath = defaultFolderPath.Replace("/", "\\");
                // 末尾にバックスラッシュがなければ追加
                if (!defaultFolderPath.EndsWith("\\"))
                {
                    defaultFolderPath = defaultFolderPath + "\\";
                }
                // パスの存在チェック
                if (!Directory.Exists(defaultFolderPath))
                {
                    defaultFolderPathWarning = "指定されたパスが存在しません";
                }
            }

            // LocalStorageに設定を保存
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateNotificationSettings",
                browserNotificationEnabled, thresholdSeconds);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateWebhookSettings",
                webHookEnabled, webHookUrl, null);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateClaudeHookSettings",
                claudeHookEnabled, hookEventStop, hookEventUserPromptSubmit, hookEventNotification);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateSpecialSettings",
                claudeModeSwitchKey);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateSessionSettings",
                sessionSortMode, showTerminalType, showGitInfo);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateDevToolsSettings",
                devToolsEnabled);
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.updateGeneralSettings",
                defaultFolderPath);

            // サーバー側のWebhook設定も保存（Hook通知用）
            WebhookSettingsService.SaveSettings(new WebhookSettings
            {
                Enabled = webHookEnabled,
                Url = webHookUrl ?? ""
            });

            // セッションソートモードの変更を通知
            await OnSessionSortModeChanged.InvokeAsync(sessionSortMode);

            // セッション表示設定の変更を通知
            await OnSessionDisplaySettingsChanged.InvokeAsync((showTerminalType, showGitInfo));

            // モード切替キーの変更を通知
            await OnClaudeModeSwitchKeyChanged.InvokeAsync(claudeModeSwitchKey);

            saveMessage = "設定を保存しました";
            saveSuccess = true;

            // 3秒後にメッセージを消す
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                await InvokeAsync(() =>
                {
                    saveMessage = "";
                    StateHasChanged();
                });
            });
        }
        catch (Exception ex)
        {
            saveMessage = $"保存エラー: {ex.Message}";
            saveSuccess = false;
        }
    }
    
    private string GetNotificationBadgeClass()
    {
        return notificationStatus switch
        {
            "許可済み" => "bg-success",
            "拒否" => "bg-danger",
            "未許可" => "bg-warning",
            _ => "bg-secondary"
        };
    }
    
    private async Task Close()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
    
    private async Task ExportSettings()
    {
        try
        {
            // 現在のストレージからセッションを取得
            var storageService = await StorageServiceFactory.GetCurrentStorageServiceAsync();
            var sessions = await storageService.LoadSessionsAsync();
            var activeSessionId = await storageService.LoadActiveSessionIdAsync();

            var exportData = new Dictionary<string, object>
            {
                ["sessions"] = sessions,
                ["activeSessionId"] = activeSessionId?.ToString() ?? "",
                ["_metadata"] = new
                {
                    exportedAt = DateTime.Now,
                    version = "2.0",
                    storageType = currentStorageType.ToString(),
                    sessionCount = sessions.Count
                }
            };

            // JSONに変換してダウンロード
            var json = System.Text.Json.JsonSerializer.Serialize(exportData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });

            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.downloadJson",
                json, $"terminalhub_sessions_{DateTime.Now:yyyyMMdd_HHmmss}.json");

            saveMessage = $"セッション情報（{sessions.Count}件）をエクスポートしました";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"エクスポートエラー: {ex.Message}";
            saveSuccess = false;
        }
    }
    
    private async Task LoadImportFile(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file.ContentType != "application/json")
            {
                saveMessage = "JSONファイルを選択してください";
                saveSuccess = false;
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();

            var importData = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(json);

            // セッション配列を取得
            if (importData.TryGetProperty("sessions", out var sessionsElement))
            {
                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };
                importSessions = System.Text.Json.JsonSerializer.Deserialize<List<SessionInfo>>(sessionsElement.GetRawText(), options);
                importSessionCount = importSessions?.Count ?? 0;
            }
            else
            {
                saveMessage = "セッション情報が見つかりませんでした";
                saveSuccess = false;
                importSessions = null;
                importSessionCount = 0;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"ファイル読み込みエラー: {ex.Message}";
            saveSuccess = false;
            importSessions = null;
            importSessionCount = 0;
        }
    }

    private async Task ImportSettings()
    {
        if (importSessions == null || importSessions.Count == 0) return;

        try
        {
            // 現在のストレージにセッションをインポート
            var storageService = await StorageServiceFactory.GetCurrentStorageServiceAsync();

            // 既存のセッションを取得
            var existingSessions = await storageService.LoadSessionsAsync();
            var existingIds = existingSessions.Select(s => s.SessionId).ToHashSet();

            // 重複しないセッションのみ追加
            int addedCount = 0;
            foreach (var session in importSessions)
            {
                if (!existingIds.Contains(session.SessionId))
                {
                    await storageService.SaveSessionAsync(session);
                    addedCount++;
                }
            }

            saveMessage = $"インポートが完了しました（{addedCount}件追加、{importSessions.Count - addedCount}件は重複のためスキップ）。ページを再読み込みしてください。";
            saveSuccess = true;
            importSessions = null;
            importSessionCount = 0;

            // 状態を更新
            await LoadMigrationTabState();
        }
        catch (Exception ex)
        {
            saveMessage = $"インポートエラー: {ex.Message}";
            saveSuccess = false;
        }
    }

    // 開発ツール関連メソッド
    private async Task RefreshDiagnostics()
    {
        try
        {
            diagnosticSessions = SessionManager.GetAllSessions().ToList();
            jsTerminalCount = await JSRuntime.InvokeAsync<int>("terminalHubHelpers.getTerminalCount");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"診断情報取得エラー: {ex.Message}");
        }
    }

    private async Task RunJSDiagnostics()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.diagnoseTerminals");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JS診断エラー: {ex.Message}");
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.scrollAllTerminalsToBottom");
            scrollInfo = $"最下部にスクロールしました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            scrollInfo = $"エラー: {ex.Message}";
        }
    }

    private async Task ScrollToTop()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.scrollAllTerminalsToTop");
            scrollInfo = $"最上部にスクロールしました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            scrollInfo = $"エラー: {ex.Message}";
        }
    }

    private async Task GetScrollPosition()
    {
        try
        {
            var result = await JSRuntime.InvokeAsync<object>("terminalHubHelpers.getAllTerminalScrollPositions");
            scrollInfo = $"スクロール位置: {System.Text.Json.JsonSerializer.Serialize(result)} - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            scrollInfo = $"エラー: {ex.Message}";
        }
    }

    private IEnumerable<SessionInfo> GetAvailableSessions()
    {
        // ConPtySessionを持っていて、アーカイブされていないセッションだけを表示
        var activeSessions = SessionManager.GetAllSessions()
            .Where(s => !s.IsArchived && s.ConPtySession != null);

        // セッションリストと同じソート順
        if (SessionSortMode == "lastAccessed")
        {
            return activeSessions.OrderByDescending(s => s.LastAccessedAt);
        }
        else
        {
            return activeSessions.OrderBy(s => s.CreatedAt);
        }
    }

    private SessionInfo? GetSelectedBufferSession()
    {
        if (string.IsNullOrEmpty(selectedSessionForBuffer) || !Guid.TryParse(selectedSessionForBuffer, out var sessionId))
            return null;
        return SessionManager.GetSessionInfo(sessionId);
    }

    private void StartCapture()
    {
        var session = GetSelectedBufferSession();
        if (session == null)
        {
            bufferResult = "セッションを選択してください";
            return;
        }
        session.StartBufferCapture();
        bufferResult = $"キャプチャを開始しました - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private void StopCapture()
    {
        var session = GetSelectedBufferSession();
        if (session == null)
        {
            bufferResult = "セッションを選択してください";
            return;
        }
        session.StopBufferCapture();
        bufferResult = $"キャプチャを停止しました - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private void ClearBuffer()
    {
        var session = GetSelectedBufferSession();
        if (session == null)
        {
            bufferResult = "セッションを選択してください";
            return;
        }
        session.ClearCapturedBuffer();
        bufferResult = $"バッファをクリアしました - {DateTime.Now:HH:mm:ss}";
        StateHasChanged();
    }

    private async Task DownloadBuffer()
    {
        try
        {
            var sessionInfo = GetSelectedBufferSession();
            if (sessionInfo == null)
            {
                bufferResult = "セッションを選択してください";
                return;
            }

            var content = sessionInfo.GetCapturedBuffer();
            if (string.IsNullOrEmpty(content))
            {
                bufferResult = "バッファが空です";
                return;
            }

            var bufferInfo = new
            {
                Status = sessionInfo.EnableBufferCapture ? "キャプチャ中" : "停止中",
                BufferSize = content.Length,
                LineCount = content.Split('\n').Length,
                CaptureStartTime = sessionInfo.BufferCaptureStartTime?.ToString("yyyy-MM-dd HH:mm:ss"),
                SessionName = sessionInfo.GetDisplayName(),
                SessionId = sessionInfo.SessionId
            };

            var header = "--- バッファ情報 ---\n" + System.Text.Json.JsonSerializer.Serialize(bufferInfo, new System.Text.Json.JsonSerializerOptions { WriteIndented = true }) + "\n\n--- バッファ内容 ---\n";
            var fullContent = header + content;
            var filename = $"buffer_{SanitizeFilename(sessionInfo.GetDisplayName())}_{DateTime.Now:yyyyMMdd_HHmmss}.txt";

            var bytes = System.Text.Encoding.UTF8.GetBytes(fullContent);
            var base64 = Convert.ToBase64String(bytes);

            await JSRuntime.InvokeVoidAsync("terminalHubHelpers.downloadBase64File", base64, filename, "text/plain");

            bufferResult = $"ダウンロード完了: {filename} ({FormatBytes(content.Length)})";
        }
        catch (Exception ex)
        {
            bufferResult = $"エラー: {ex.Message}";
        }
    }

    private string FormatBytes(int bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private string SanitizeFilename(string filename)
    {
        var invalidChars = Path.GetInvalidFileNameChars();
        var sanitized = filename;
        foreach (var c in invalidChars)
        {
            sanitized = sanitized.Replace(c, '_');
        }
        return sanitized;
    }

    private async Task TestBrowserNotification()
    {
        try
        {
            var testSession = new SessionInfo
            {
                SessionId = Guid.NewGuid(),
                FolderPath = "C:\\TestFolder",
                DisplayName = "通知テストセッション",
                TerminalType = TerminalType.ClaudeCode,
                ProcessingElapsedSeconds = testElapsedSeconds
            };

            notificationTestResult = $"ブラウザ通知を送信中... ({testElapsedSeconds}秒の処理として)";
            StateHasChanged();

            await NotificationService.NotifyProcessingCompleteAsync(testSession, testElapsedSeconds);

            notificationTestResult = $"ブラウザ通知を送信しました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            notificationTestResult = $"エラー: {ex.Message}";
        }
    }

    private async Task TestWebHookNotification()
    {
        try
        {
            var testSession = new SessionInfo
            {
                SessionId = Guid.NewGuid(),
                FolderPath = "C:\\TestFolder",
                DisplayName = "WebHookテストセッション",
                TerminalType = TerminalType.GeminiCLI,
                ProcessingElapsedSeconds = testElapsedSeconds
            };

            notificationTestResult = $"WebHook通知を送信中... ({testElapsedSeconds}秒の処理として)";
            StateHasChanged();

            await NotificationService.NotifyProcessingCompleteAsync(testSession, testElapsedSeconds);

            notificationTestResult = $"WebHook通知を送信しました - {DateTime.Now:HH:mm:ss}";
        }
        catch (Exception ex)
        {
            notificationTestResult = $"エラー: {ex.Message}";
        }
    }

    // データ移行関連メソッド
    private async Task LoadMigrationTabState()
    {
        try
        {
            // SQLite DBの存在チェック
            var sqliteExists = StorageServiceFactory.SqliteDatabaseExists;

            // SQLiteのパスを設定
            var appDataPath = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
            sqliteDbPath = Path.Combine(appDataPath, "TerminalHub", "sessions.db");

            // 常にLocalStorageのデータを読み込む（再移行用）
            try
            {
                var localSessions = await LocalStorageService.LoadSessionsAsync();
                localStorageSessionCount = localSessions.Count;

                // データサイズを概算（JSON形式のサイズ）
                var json = System.Text.Json.JsonSerializer.Serialize(localSessions);
                localStorageDataSize = System.Text.Encoding.UTF8.GetByteCount(json);
            }
            catch
            {
                localStorageSessionCount = 0;
                localStorageDataSize = 0;
            }

            if (sqliteExists)
            {
                // SQLite使用中
                currentStorageType = StorageType.SQLite;
                sqliteSessionCount = await StorageServiceFactory.GetSqliteSessionCountAsync();
                currentStorageSessionCount = sqliteSessionCount;
                // SQLite使用中でも、LocalStorageにデータがあれば再移行可能なのでタブを表示
                showMigrationTab = true;
            }
            else
            {
                // LocalStorage使用中
                currentStorageType = StorageType.LocalStorage;
                currentStorageSessionCount = localStorageSessionCount;
                // LocalStorageにセッションがある場合のみ移行タブを表示
                showMigrationTab = localStorageSessionCount > 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"データ移行状態の読み込みエラー: {ex.Message}");
            showMigrationTab = false;
        }
    }

    private async Task MigrateToSqlite()
    {
        if (isMigrating) return;

        isMigrating = true;
        StateHasChanged();

        try
        {
            // LocalStorageからデータを取得
            var sessions = await LocalStorageService.LoadSessionsAsync();
            var activeSessionId = await LocalStorageService.LoadActiveSessionIdAsync();
            var expandedStates = await LocalStorageService.LoadSessionExpandedStatesAsync();

            // SQLiteに移行
            var success = await StorageServiceFactory.MigrateToSqliteAsync(sessions, activeSessionId, expandedStates);

            if (success)
            {
                saveMessage = "SQLiteへの移行が完了しました。ページを再読み込みしてください。";
                saveSuccess = true;
                currentStorageType = StorageType.SQLite;
                sqliteSessionCount = sessions.Count;
            }
            else
            {
                saveMessage = "SQLiteへの移行に失敗しました";
                saveSuccess = false;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"移行エラー: {ex.Message}";
            saveSuccess = false;
        }
        finally
        {
            isMigrating = false;
            StateHasChanged();
        }
    }
}